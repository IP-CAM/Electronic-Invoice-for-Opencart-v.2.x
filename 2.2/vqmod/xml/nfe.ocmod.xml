<?xml version="1.0" encoding="UTF-8"?>
<modification>
   <id>Insert new fields to registration form</id>
   <author>WebmaniaBR</author>
   <file name="admin/model/sale/order.php">
     <operation info="Get NF-e Status from DB">
       <search position="replace" ><![CDATA[
       $sql = "SELECT o.order_id, CONCAT(o.firstname, ' ', o.lastname) AS customer, (SELECT os.name FROM " . DB_PREFIX . "order_status os WHERE os.order_status_id = o.order_status_id AND os.language_id = '" . (int)$this->config->get('config_language_id') . "') AS order_status, o.shipping_code, o.total, o.currency_code, o.currency_value, o.date_added, o.date_modified FROM `" . DB_PREFIX . "order` o";
       ]]></search>
       <add><![CDATA[
       $sql = "SELECT o.order_id, CONCAT(o.firstname, ' ', o.lastname) AS customer, (SELECT os.name FROM " . DB_PREFIX . "order_status os WHERE os.order_status_id = o.order_status_id AND os.language_id = '" . (int)$this->config->get('config_language_id') . "') AS order_status, o.shipping_code, o.total, o.currency_code, o.currency_value, o.date_added, o.date_modified, o.status_nfe FROM `" . DB_PREFIX . "order` o";
       ]]></add>
     </operation>
   </file>
   <file name="admin/controller/sale/order.php">
     <operation info="Assign NF-E Status value to array key">
       <search position="before" ><![CDATA[
       'order_status'  => $result['order_status'],
       ]]></search>
       <add><![CDATA[
       'status_nfe'  => $result['status_nfe'],
       ]]></add>
     </operation>
     <operation info="Add custom BULK action">
       <search position="after" ><![CDATA[
       $data['shipping'] = $this->url->link('sale/order/shipping', 'token=' . $this->session->data['token'], true);
       ]]></search>
       <add><![CDATA[
       $data['emitir_nfe'] = $this->url->link('module/webmaniabrnfe/emitirNFe', 'token=' . $this->session->data['token'], true);
       ]]></add>
     </operation>
     <operation info="Add custom BULK action">
       <search position="before" ><![CDATA[
       $this->response->setOutput($this->load->view('sale/order_list', $data));
       ]]></search>
       <add><![CDATA[
       if(isset($this->session->data['success'])){
       $data['success'] = $this->session->data['success'];
       unset($this->session->data['success']);
       }

       if(isset($this->session->data['error_warning'])){
       $data['error_warning'] = $this->session->data['error_warning'];
       unset($this->session->data['error_warning']);
       }
       ]]></add>
     </operation>


   </file>
   <file name="admin/view/template/common/header.tpl">
    <operation info="Include module CSS">
      <search position="before" ><![CDATA[
      </head>
      ]]></search>
      <add><![CDATA[
        <link rel="stylesheet" href="./view/stylesheet/wmbr_style.css" />
        <script type="text/javascript" src="../catalog/view/javascript/wmbr_script.js"></script>
        <script type="text/javascript" src="../catalog/view/javascript/jquery.mask.min.js"></script>
        <script type="text/javascript" src="../catalog/view/javascript/correios.min.js"></script>
      ]]></add>
    </operation>
  </file>
   <file name="admin/view/template/sale/order_list.tpl">
    <operation info="Insert new column to orders table">
      <search position="before" offset="1" ><![CDATA[
      <a href="<?php echo $sort_status; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_status; ?></a>
      ]]></search>
      <add><![CDATA[
        <td class="text-left">
          <a href="<?php echo $sort_customer; ?>">Status NF-e</a>
        </td>
      ]]></add>
    </operation>
    <operation info="Insert new column to orders table">
      <search position="before" ><![CDATA[
      <td class="text-left"><?php echo $order['order_status']; ?></td>
      ]]></search>
      <add><![CDATA[
        <?php if($order['status_nfe'] == 0){ ?>
          <td class="text-left"><div class="nfe-status nao-emitida">Não emitida</div></td>
       <?php }else if($order['status_nfe'] == 1){ ?>
          <td class="text-left"><div class="nfe-status emitida">Emitida</div></td>
       <?php } ?>
      ]]></add>
    </operation>
    <operation info="Replace colspan 8 for colspan 9 due to new column">
      <search position="replace"><![CDATA[
      <td class="text-center" colspan="8"><?php echo $text_no_results; ?></td>
      ]]></search>
      <add><![CDATA[
      <td class="text-center" colspan="9"><?php echo $text_no_results; ?></td>
      ]]></add>
    </operation>
    <operation info="Add Bulk Action Button">
      <search position="before"><![CDATA[
      <button type="submit" id="button-shipping" form="form-order" formaction="<?php echo $shipping; ?>" data-toggle="tooltip" title="<?php echo $button_shipping_print; ?>" class="btn btn-info"><i class="fa fa-truck"></i></button>
      ]]></search>
      <add><![CDATA[
      <button type="submit" id="button-emitir-nfe" form="form-order" formaction="<?php echo $emitir_nfe; ?>" data-toggle="tooltip" title="Emitir Notas Fiscais" class="btn btn-info"><i class="fa fa-file-text-o"></i> Emitir NF-e</button>
      ]]></add>
    </operation>
    <operation info="Remove target _blank">
      <search position="before"><![CDATA[
      $('#button-shipping, #button-invoice').on('click', function(e) {
      ]]></search>
      <add><![CDATA[
      $('#button-emitir-nfe').on('click', function(e) {
        $('#form-order').removeAttr('target');
      });
      ]]></add>
    </operation>
    <operation info="Add Success and Warning messages">
      <search position="after" offset="4"><![CDATA[
      <ul class="breadcrumb">
      ]]></search>
      <add><![CDATA[
        <?php if(isset($success)): ?>
        <div class="alert-wmbr alert-success"><?php echo $success; ?></div>
        <?php endif; ?>

        <?php if(isset($error_warning)): ?>
        <div class="alert-wmbr alert-danger"><?php echo $error_warning ?></div>
        <?php endif; ?>
      ]]></add>
    </operation>

  </file>


  <file name="catalog/view/theme/*/template/common/header.tpl">
   <operation info="Include module CSS and JS">
     <search position="after" ><![CDATA[
     </head>
     ]]></search>
     <add><![CDATA[
       <link rel="stylesheet" href="admin/view/stylesheet/wmbr_style.css" />
       <script type="text/javascript" src="catalog/view/javascript/wmbr_script.js"></script>
       <script type="text/javascript" src="catalog/view/javascript/jquery.mask.min.js"></script>
       <script type="text/javascript" src="catalog/view/javascript/correios.min.js"></script>
     ]]></add>
   </operation>
 </file>

  <file name="catalog/view/theme/*/template/account/register.tpl">
    <operation info="Insert new document type fields">
        <search position="before" offset="1"><![CDATA[
        <label class="col-sm-2 control-label" for="input-firstname"><?php echo $entry_firstname; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="col-sm-2 control-label">Tipo de Pessoa</label>
            <div class="col-sm-10">
              <?php if($doctype == 'cnpj'): ?>
              <input type="radio" name="doctype" value="cpf" /> <span class="radio-label">Pessoa Física</span>
              <input type="radio" name="doctype" value="cnpj" checked/> <span class="radio-label">Pessoa Jurídica</span>
              <?php else: ?>
              <input type="radio" name="doctype" value="cpf" checked/> <span class="radio-label">Pessoa Física</span>
              <input type="radio" name="doctype" value="cnpj" /> <span class="radio-label">Pessoa Jurídica</span>
              <?php endif; ?>

            </div>
          </div>
          <div class="form-group required" id="cpf-group" <?php if($doctype == 'cnpj') echo 'style="display:none;"'; ?>>
            <label class="col-sm-2 control-label">CPF</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="cpf" id="cpf" placeholder="CPF" value="<?php if($doctype == 'cpf') echo $document_number; ?>"/>
              <?php if ($error_cpf) { ?>
              <div class="text-danger"><?php echo $error_cpf; ?></div>
              <?php } ?>
            </div>
          </div>
          <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
            <label class="col-sm-2 control-label">Razão Social</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="razao_social" placeholder="Razão Social" value="<?php echo $razao_social; ?>"/>
              <?php if ($error_razao_social) { ?>
              <div class="text-danger"><?php echo $error_razao_social; ?></div>
              <?php } ?>
            </div>
          </div>
          <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
            <label class="col-sm-2 control-label">CNPJ</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="cnpj" id="cnpj" placeholder="CNPJ" value="<?php if($doctype == 'cnpj') echo $document_number; ?>"/>
              <?php if ($error_cnpj) { ?>
              <div class="text-danger"><?php echo $error_cnpj; ?></div>
              <?php } ?>
            </div>
          </div>
          <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
            <label class="col-sm-2 control-label">Inscrição Estadual</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="cnpj_ie" placeholder="Inscrição Estadual" value="<?php echo $cnpj_ie; ?>"/>
              <?php if ($error_cnpj_ie) { ?>
              <div class="text-danger"><?php echo $error_cnpj_ie; ?></div>
              <?php } ?>
            </div>
          </div>
        ]]></add>
    </operation>
    <operation info="Change Position of Postcode Field">
        <search position="replace" offset="6"><![CDATA[
        <label class="col-sm-2 control-label" for="input-postcode"><?php echo $entry_postcode; ?></label>
        ]]></search>
        <add><![CDATA[
        ]]></add>
    </operation>
    <operation info="Change Position of Postcode Field">
        <search position="before" offset="1"><![CDATA[
        <label class="col-sm-2 control-label" for="input-address-1"><?php echo $entry_address_1; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-postcode"><?php echo $entry_postcode; ?></label>
            <div class="col-sm-10">
              <input type="text" name="postcode" value="<?php echo $postcode; ?>" placeholder="<?php echo $entry_postcode; ?>" id="input-postcode" class="form-control" />
              <?php if ($error_postcode) { ?>
              <div class="text-danger"><?php echo $error_postcode; ?></div>
              <?php } ?>
            </div>
          </div>
        ]]></add>
    </operation>
    <operation info="Insert loading div">
        <search position="after"><![CDATA[
        <fieldset id="address">
        ]]></search>
        <add><![CDATA[
          <div class="correios-loading"></div>
        ]]></add>
    </operation>
    <operation info="Insert Address Number Field">
        <search position="before" offset="1"><![CDATA[
        <label class="col-sm-2 control-label" for="input-city"><?php echo $entry_city; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-address-number">Número</label>
            <div class="col-sm-10">
              <input type="text" name="address_number" placeholder="Número" id="input-address-number" class="form-control" value="<?php echo $address_number; ?>" />
              <?php if ($error_address_number) { ?>
              <div class="text-danger"><?php echo $error_address_number; ?></div>
              <?php } ?>
            </div>
          </div>
        ]]></add>
    </operation>
    <operation info="Insert Error into Address 2">
        <search position="after"><![CDATA[
        <input type="text" name="address_2" value="<?php echo $address_2; ?>" placeholder="<?php echo $entry_address_2; ?>" id="input-address-2" class="form-control" />
        ]]></search>
        <add><![CDATA[
          <?php if ($error_address_2) { ?>
          <div class="text-danger"><?php echo $error_address_2; ?></div>
          <?php } ?>
        ]]></add>
    </operation>
  </file>
  <file name="catalog/controller/account/register.php">
      <operation info="Validate Custom Fields">
          <search position="after"><![CDATA[
          private function validate() {
          ]]></search>
          <add><![CDATA[
            if ( $this->request->post['doctype'] == 'cpf' && ((utf8_strlen(trim($this->request->post['cpf'])) < 1) || (utf8_strlen(trim($this->request->post['cpf'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCPF', array($this->request->post['cpf'])) === false)) {
        			$this->error['cpf'] = 'CPF Inválido!';
        		}

            if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCNPJ', array($this->request->post['cnpj'])) === false)) {
        			$this->error['cnpj'] = 'CNPJ Inválido!';
        		}

            if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj_ie'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj_ie'])) > 32))) {
        			$this->error['cnpj_ie'] = 'Inscrição estadual inválida!';
        		}

            if ((utf8_strlen(trim($this->request->post['address_number'])) < 1) || (utf8_strlen(trim($this->request->post['address_number'])) > 32)) {
        			$this->error['address_number'] = 'Número Inválido!';
        		}

            if ((utf8_strlen(trim($this->request->post['address_2'])) < 1) || (utf8_strlen(trim($this->request->post['address_2'])) > 32)) {
        			$this->error['address_2'] = 'Bairro deve conter entre 2 e 32 caracteres!';
        		}

            if ($this->request->post['doctype'] == 'cnpj'){
              if ((utf8_strlen(trim($this->request->post['razao_social'])) < 1) || (utf8_strlen(trim($this->request->post['razao_social'])) > 50)) {
          			$this->error['razao_social'] = 'Razão social obrigatória!';
          		}
            }
          ]]></add>
      </operation>
      <operation info="Define error variable">
          <search position="before"><![CDATA[
          if (isset($this->error['firstname'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->error['cpf'])) {
        			$data['error_cpf'] = $this->error['cpf'];
        		} else {
        			$data['error_cpf'] = '';
        		}
            if (isset($this->error['cnpj'])) {
        			$data['error_cnpj'] = $this->error['cnpj'];
        		} else {
        			$data['error_cnpj'] = '';
        		}
            if (isset($this->error['address_number'])) {
        			$data['error_address_number'] = $this->error['address_number'];
        		} else {
        			$data['error_address_number'] = '';
        		}

            if (isset($this->error['cnpj_ie'])) {
        			$data['error_cnpj_ie'] = $this->error['cnpj_ie'];
        		} else {
        			$data['error_cnpj_ie'] = '';
        		}

            if (isset($this->error['razao_social'])) {
        			$data['error_razao_social'] = $this->error['razao_social'];
        		} else {
        			$data['error_razao_social'] = '';
        		}

            if (isset($this->error['address_2'])) {
        			$data['error_address_2'] = $this->error['address_2'];
        		} else {
        			$data['error_address_2'] = '';
        		}
          ]]></add>
      </operation>
      <operation info="Define requested POST vars">
          <search position="before"><![CDATA[
          if (isset($this->request->post['firstname'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->request->post['doctype'])) {
             $data['doctype'] = $this->request->post['doctype'];
           } else {
             $data['doctype'] = '';
           }

            if (isset($this->request->post['cpf'])) {
              if($this->request->post['doctype'] == 'cpf'){
                $data['document_number'] = $this->request->post['cpf'];
              }elseif($this->request->post['doctype'] == 'cnpj'){
                $data['document_number'] = $this->request->post['cnpj'];
              }
           } else {
             $data['document_number'] = '';
           }

          if (isset($this->request->post['cnpj_ie'])) {
           $data['cnpj_ie'] = $this->request->post['cnpj_ie'];
         } else {
           $data['cnpj_ie'] = '';
         }

          if (isset($this->request->post['address_number'])) {
           $data['address_number'] = $this->request->post['address_number'];
         } else {
           $data['address_number'] = '';
         }

         if (isset($this->request->post['razao_social'])) {
          $data['razao_social'] = $this->request->post['razao_social'];
        } else {
          $data['razao_social'] = '';
        }
          ]]></add>
      </operation>
      <operation info="Rename address 2">
          <search position="replace"><![CDATA[
          $data['entry_address_2'] = $this->language->get('entry_address_2');
          ]]></search>
          <add><![CDATA[
            $data['entry_address_2'] = 'Bairro';
          ]]></add>
      </operation>
  </file>

  <file name="catalog/view/theme/*/template/checkout/register.tpl,catalog/view/theme/*/template/checkout/guest.tpl">
    <operation info="Insert new document type fields">
        <search position="before" offset="1"><![CDATA[
          <label class="control-label" for="input-payment-firstname"><?php echo $entry_firstname; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="control-label" style="margin-right:10px;">Tipo de Pessoa</label>
              <input type="radio" name="doctype" value="cpf" checked/> <span class="radio-label">Pessoa Física</span>
              <input type="radio" name="doctype" value="cnpj" /> <span class="radio-label">Pessoa Jurídica</span>
          </div>
          <div class="form-group required" id="cpf-group">
            <label class="control-label">CPF</label>
            <input type="text" class="form-control" name="cpf" id="input-payment-cpf" placeholder="CPF" />
          </div>
          <div class="form-group required cnpj-group" >
            <label class="control-label">Razão Social</label>
              <input type="text" class="form-control" name="razao_social" id="input-payment-razao-social" placeholder="Razão Social" />
          </div>
          <div class="form-group required cnpj-group" >
            <label class="control-label">CNPJ</label>
              <input type="text" class="form-control" name="cnpj" id="input-payment-cnpj" placeholder="CNPJ" />
          </div>
          <div class="form-group required cnpj-group" >
            <label class="control-label">Inscrição Estadual</label>
              <input type="text" class="form-control" name="cnpj_ie" id="input-payment-cnpj-ie" placeholder="Inscrição Estadual"/>
          </div>
        ]]></add>
    </operation>
    <operation info="Change Position of Postcode Field">
        <search position="replace" offset="3"><![CDATA[
        <label class="control-label" for="input-payment-postcode"><?php echo $entry_postcode; ?></label>
        ]]></search>
        <add><![CDATA[
        ]]></add>
    </operation>
    <operation info="Change Position of Postcode Field">
        <search position="before" offset="1"><![CDATA[
        <label class="control-label" for="input-payment-address-1"><?php echo $entry_address_1; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="control-label" for="input-payment-postcode"><?php echo $entry_postcode; ?></label>
            <input type="text" name="postcode" value="<?php echo $postcode; ?>" placeholder="<?php echo $entry_postcode; ?>" id="input-payment-postcode" class="form-control" />
          </div>
        ]]></add>
    </operation>
    <operation info="Insert loading div">
        <search position="after"><![CDATA[
        <fieldset id="address">
        ]]></search>
        <add><![CDATA[
          <div class="correios-loading"></div>
        ]]></add>
    </operation>
    <operation info="Insert Address Number Field">
        <search position="before" offset="1"><![CDATA[
        <label class="control-label" for="input-payment-city"><?php echo $entry_city; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="control-label" for="input-payment-address_number">Número</label>
              <input type="text" name="address_number" placeholder="Número" id="input-payment-address-number" class="form-control" />
          </div>
        ]]></add>
    </operation>
  </file>
  <file name="catalog/controller/checkout/register.php,catalog/controller/checkout/guest.php">
      <operation info="Validate fields checkout register">
          <search position="before"><![CDATA[
          if ((utf8_strlen(trim($this->request->post['firstname'])) < 1) || (utf8_strlen(trim($this->request->post['firstname'])) > 32)) {
          ]]></search>
          <add><![CDATA[
            if ( $this->request->post['doctype'] == 'cpf' && ((utf8_strlen(trim($this->request->post['cpf'])) < 1) || (utf8_strlen(trim($this->request->post['cpf'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCPF', array($this->request->post['cpf'])) === false)) {
        			$json['error']['cpf'] = 'CPF Inválido!';
        		}

            if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCNPJ', array($this->request->post['cnpj'])) === false)) {
        			$json['error']['cnpj'] = 'CNPJ Inválido!';
        		}

            if ((utf8_strlen(trim($this->request->post['address_number'])) < 1) || (utf8_strlen(trim($this->request->post['address_number'])) > 32)) {
      				$json['error']['address_number'] = 'Número inválido!';
      			}

            if ((utf8_strlen(trim($this->request->post['address_2'])) < 1) || (utf8_strlen(trim($this->request->post['address_2'])) > 32)) {
      				$json['error']['address_2'] = 'Bairro deve conter entre 2 e 32 caracteres!';
      			}

            if ( $this->request->post['doctype'] == 'cnpj'){
            if ((utf8_strlen(trim($this->request->post['razao_social'])) < 1) || (utf8_strlen(trim($this->request->post['razao_social'])) > 50)) {
      				$json['error']['razao_social'] = 'Número inválido!';
      			}
            }

            if ( $this->request->post['doctype'] == 'cnpj'){
            if ((utf8_strlen(trim($this->request->post['cnpj_ie'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj_ie'])) > 50)) {
      				$json['error']['cnpj_ie'] = 'Número inválido!';
      			}
            }


          ]]></add>
      </operation>
      <operation info="Rename address 2">
          <search position="replace"><![CDATA[
          $data['entry_address_2'] = $this->language->get('entry_address_2');
          ]]></search>
          <add><![CDATA[
            $data['entry_address_2'] = 'Bairro';
           ]]></add>
      </operation>
  </file>
  <file name="catalog/view/theme/*/template/account/edit.tpl">
      <operation info="Insert doctype fields to edit account">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-firstname"><?php echo $entry_firstname; ?> </label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label">Tipo de Pessoa</label>
              <div class="col-sm-10">
                <?php if($doctype == 'cnpj'): ?>
                <input type="radio" name="doctype" value="cpf" /> <span class="radio-label">Pessoa Física</span>
                <input type="radio" name="doctype" value="cnpj" checked/> <span class="radio-label">Pessoa Jurídica</span>
                <?php else: ?>
                <input type="radio" name="doctype" value="cpf" checked/> <span class="radio-label">Pessoa Física</span>
                <input type="radio" name="doctype" value="cnpj" /> <span class="radio-label">Pessoa Jurídica</span>
                <?php endif; ?>
              </div>
            </div>
            <div class="form-group required" id="cpf-group" <?php if($doctype == 'cnpj') echo 'style="display:none;"'; ?>>
              <label class="col-sm-2 control-label">CPF</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" name="cpf" id="cpf" placeholder="CPF" value="<?php if($doctype == 'cpf') echo $document_number; ?>"/>
                <?php if ($error_cpf) { ?>
                <div class="text-danger"><?php echo $error_cpf; ?></div>
                <?php } ?>
              </div>
            </div>
            <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
              <label class="col-sm-2 control-label">Razão Social</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" name="razao_social" placeholder="Razão Social" value="<?php echo $razao_social; ?>"/>
                <?php if ($error_razao_social) { ?>
                <div class="text-danger"><?php echo $error_razao_social; ?></div>
                <?php } ?>
              </div>
            </div>
            <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
              <label class="col-sm-2 control-label">CNPJ</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" name="cnpj" id="cnpj" placeholder="CNPJ" value="<?php if($doctype == 'cnpj') echo $document_number; ?>"/>
                <?php if ($error_cnpj) { ?>
                <div class="text-danger"><?php echo $error_cnpj; ?></div>
                <?php } ?>
              </div>
            </div>
            <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
              <label class="col-sm-2 control-label">Inscrição Estadual</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" name="cnpj_ie" placeholder="Inscrição Estadual"value="<?php if($doctype == 'cnpj') echo $cnpj_ie; ?>"/>
                <?php if ($error_cnpj_ie) { ?>
                <div class="text-danger"><?php echo $error_cnpj_ie; ?></div>
                <?php } ?>
              </div>
            </div>
           ]]></add>
      </operation>
  </file>
  <file name="catalog/view/theme/*/template/checkout/payment_address.tpl">
      <operation info="Change postcode position">
          <search position="replace" offset="3"><![CDATA[
          <label class="col-sm-2 control-label" for="input-payment-postcode"><?php echo $entry_postcode; ?></label>
          ]]></search>
          <add><![CDATA[
           ]]></add>
      </operation>
      <operation info="Change postcode position">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-payment-address-1"><?php echo $entry_address_1; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-payment-postcode"><?php echo $entry_postcode; ?></label>
              <div class="col-sm-10">
                <input type="text" name="postcode" value="" placeholder="<?php echo $entry_postcode; ?>" id="input-payment-postcode" class="form-control" />
              </div>
            </div>
           ]]></add>
      </operation>
      <operation info="Insert correios loading">
          <search position="before"><![CDATA[
          <form class="form-horizontal">
          ]]></search>
          <add><![CDATA[
            <div class="correios-loading"></div>
           ]]></add>
      </operation>
      <operation info="Insert address number">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-payment-city"><?php echo $entry_city; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-address-number">Número</label>
              <div class="col-sm-10">
                <input type="text" name="address_number" placeholder="Número" id="input-payment-address-number" class="form-control"  />
              </div>
            </div>
           ]]></add>
      </operation>
  </file>
  <file name="catalog/controller/checkout/payment_address.php,catalog/controller/checkout/shipping_address.php">
    <operation info="Rename address 2">
        <search position="replace"><![CDATA[
        $data['entry_address_2'] = $this->language->get('entry_address_2');
        ]]></search>
        <add><![CDATA[
          $data['entry_address_2'] = 'Bairro';
         ]]></add>
    </operation>
      <operation info="Change postcode position">
          <search position="replace" offset="3"><![CDATA[
          if ((utf8_strlen(trim($this->request->post['firstname'])) < 1) || (utf8_strlen(trim($this->request->post['firstname'])) > 32)) {
          ]]></search>
          <add><![CDATA[
            if ((utf8_strlen(trim($this->request->post['address_number'])) < 1) || (utf8_strlen(trim($this->request->post['address_number'])) > 32)) {
    					$json['error']['address_number'] = 'Número inválido!';
    				}

            if ((utf8_strlen(trim($this->request->post['address_2'])) < 1) || (utf8_strlen(trim($this->request->post['address_2'])) > 32)) {
    					$json['error']['address_2'] = 'Bairro deve conter entre 2 e 32 caracteres!';
    				}
           ]]></add>
      </operation>
      <operation info="Validate existing address">
          <search position="before"><![CDATA[
          if (empty($this->request->post['address_id'])) {
          ]]></search>
          <add><![CDATA[
            $user_id = (int)$this->customer->getId();
            $this->load->model('account/customer');
            $customer = $this->model_account_customer->getCustomer($user_id);
            $msg = '';

            if(empty($customer['document_number'])){
              $url = $this->url->link('account/edit');
              $msg .= '<li>Esta conta não possui nenhum número de documento definido. Edite sua conta e insira o número do CPF/CNPJ para continuar. <a href="'.$url.'">Editar conta</a></li>';
            }

            $result = $this->model_account_address->getAddress($this->request->post['address_id']);
    				if(empty($result['address_number'])){
    					$url = $this->url->link('account/address/edit', 'address_id=' . $this->request->post['address_id'], true);
    					$msg .= '<li>Este endereço não possui nenhum número definido. Caso você tenha definido o número no mesmo campo que o endereço, vá até sua conta e edite-o, inserindo o número no campo denominado "Número". <a href="'.$url.'">Editar endereço</a></li>';
    				}

            if(empty($result['address_number']) || empty($customer['document_number'])){
              $json['error']['warning'] = $msg;
            }
           ]]></add>
      </operation>
  </file>


  <file name="catalog/view/theme/*/template/checkout/guest_shipping.tpl,catalog/view/theme/*/template/checkout/shipping_address.tpl">
      <operation info="Change postcode position">
          <search position="replace" offset="3"><![CDATA[
          <label class="col-sm-2 control-label" for="input-shipping-postcode"><?php echo $entry_postcode; ?></label>
          ]]></search>
          <add><![CDATA[
           ]]></add>
      </operation>
      <operation info="Change postcode position">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-shipping-address-1"><?php echo $entry_address_1; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-shipping-postcode"><?php echo $entry_postcode; ?></label>
              <div class="col-sm-10">
                <input type="text" name="postcode" value="<?php echo $postcode; ?>" placeholder="<?php echo $entry_postcode; ?>" id="input-shipping-postcode" class="form-control" />
              </div>
            </div>
           ]]></add>
      </operation>
      <operation info="Insert correios loading">
          <search position="before"><![CDATA[
          <form class="form-horizontal">
          ]]></search>
          <add><![CDATA[
            <div class="correios-loading"></div>
           ]]></add>
      </operation>
      <operation info="Insert address number">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-shipping-city"><?php echo $entry_city; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-address-number">Número</label>
              <div class="col-sm-10">
                <input type="text" name="address_number" placeholder="Número" id="input-shipping-address-number" class="form-control"  />
              </div>
            </div>
           ]]></add>
      </operation>
  </file>
  <file name="catalog/controller/account/edit.php">
      <operation info="Assign custom fields variables">
          <search position="before"><![CDATA[
          if (isset($this->request->post['firstname'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->request->post['doctype'])) {
             $data['doctype'] = $this->request->post['doctype'];
            } elseif (isset($customer_info)) {
               $data['doctype'] = $customer_info['document_type'];
             } else {
               $data['doctype'] = 'cpf';
             }

             if (isset($this->request->post['cnpj_ie'])) {
              $data['cnpj_ie'] = $this->request->post['cnpj_ie'];
             } elseif (isset($customer_info)) {
                $data['cnpj_ie'] = $customer_info['pj_ie'];
              } else {
                $data['cnpj_ie'] = '';
              }

             if (isset($this->request->post['cpf']) || isset($this->request->post['cpf'])) {
             if($this->request->post['doctype'] == 'cpf'){
             $data['document_number'] = $this->request->post['cpf'];
             }elseif($this->request->post['doctype'] == 'cnpj'){
             $data['document_number'] = $this->request->post['cnpj'];
             }
             } elseif (isset($customer_info)) {
             $data['document_number'] = $customer_info['document_number'];
             } else {
             $data['document_number'] = '';
             }

             if (isset($this->request->post['razao_social'])) {
              $data['razao_social'] = $this->request->post['razao_social'];
             } elseif (isset($customer_info)) {
                $data['razao_social'] = $customer_info['razao_social'];
              } else {
                $data['razao_social'] = '';
              }
           ]]></add>
      </operation>
      <operation info="Validate custom fields">
          <search position="after"><![CDATA[
          protected function validate() {
          ]]></search>
          <add><![CDATA[
            if ( $this->request->post['doctype'] == 'cpf' && ((utf8_strlen(trim($this->request->post['cpf'])) < 1) || (utf8_strlen(trim($this->request->post['cpf'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCPF', array($this->request->post['cpf'])) === false)) {
        			$this->error['cpf'] = 'CPF Inválido!';
        		}

            if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCNPJ', array($this->request->post['cnpj'])) === false)) {
        			$this->error['cnpj'] = 'CNPJ Inválido!';
        		}

            if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj_ie'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj_ie'])) > 32))) {
        			$this->error['cnpj_ie'] = 'Inscrição estadual inválida!';
        		}

            if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['razao_social'])) < 1) || (utf8_strlen(trim($this->request->post['razao_social'])) > 50))) {
        			$this->error['razao_social'] = 'Razão Social Obrigatória!';
        		}
           ]]></add>
      </operation>
      <operation info="Assign error variables">
          <search position="before"><![CDATA[
          if (isset($this->error['firstname'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->error['cpf'])) {
        			$data['error_cpf'] = $this->error['cpf'];
        		} else {
        			$data['error_cpf'] = '';
        		}

            if (isset($this->error['cnpj'])) {
        			$data['error_cnpj'] = $this->error['cnpj'];
        		} else {
        			$data['error_cnpj'] = '';
        		}

            if (isset($this->error['cnpj_ie'])) {
        			$data['error_cnpj_ie'] = $this->error['cnpj_ie'];
        		} else {
        			$data['error_cnpj_ie'] = '';
        		}

            if (isset($this->error['razao_social'])) {
        			$data['error_razao_social'] = $this->error['razao_social'];
        		} else {
        			$data['error_razao_social'] = '';
        		}
           ]]></add>
      </operation>

  </file>
  <file name="catalog/model/account/customer.php">
      <operation info="Insert document type and number into DB after user inserted">
          <search position="after"><![CDATA[
          $customer_id = $this->db->getLastId();
          ]]></search>
          <add><![CDATA[
            if($data['doctype'] == 'cpf'){
              $document_number = preg_replace("/[^0-9]/","",$data['cpf']);
            }elseif($data['doctype'] == 'cnpj'){
              $document_number = preg_replace("/[^0-9]/","",$data['cnpj']);
            }

           $this->db->query("UPDATE " . DB_PREFIX . "customer SET document_type = '" . $this->db->escape($data['doctype']) . "', document_number = '" . $this->db->escape($document_number) . "' WHERE customer_id = '" . (int)$customer_id . "'");

           if($data['doctype'] == 'cnpj'){
           $this->db->query("UPDATE " . DB_PREFIX . "customer SET pj_ie = '" . $this->db->escape($data['cnpj_ie']) . "', razao_social = '" . $this->db->escape($data['razao_social']) . "' WHERE customer_id = '" . (int)$customer_id . "'");
           }
          ]]></add>
      </operation>
      <operation info="Insert addess number into DB after address inserted">
          <search position="after"><![CDATA[
          $address_id = $this->db->getLastId();
          ]]></search>
          <add><![CDATA[
           $this->db->query("UPDATE " . DB_PREFIX . "address SET address_number = '" . $this->db->escape($data['address_number']) . "' WHERE address_id = '" . (int)$address_id . "' AND customer_id = '" . (int)$customer_id . "'");
          ]]></add>
      </operation>
      <operation>
          <search position="after"><![CDATA[
          $this->db->query("UPDATE " . DB_PREFIX . "customer SET firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', custom_field = '" . $this->db->escape(isset($data['custom_field']) ? json_encode($data['custom_field']) : '') . "' WHERE customer_id = '" . (int)$customer_id . "'");
          ]]></search>
          <add><![CDATA[
            if($data['doctype'] == 'cpf'){
            $document_number = preg_replace("/[^0-9]/","",$data['cpf']);
            }elseif($data['doctype'] == 'cnpj'){
            $document_number = preg_replace("/[^0-9]/","",$data['cnpj']);
            }

            $this->db->query("UPDATE " . DB_PREFIX . "customer SET document_type =  '" . $this->db->escape($data['doctype']) . "', document_number =  '" . $this->db->escape($document_number)  . "' WHERE customer_id = '" . (int)$this->customer->getId() . "'");

            if($data['doctype'] == 'cnpj'){
            $this->db->query("UPDATE " . DB_PREFIX . "customer SET pj_ie = '" . $this->db->escape($data['cnpj_ie']) . "', razao_social = '" . $this->db->escape($data['razao_social']) . "' WHERE customer_id = '" . (int)$customer_id . "'");
            }
          ]]></add>
      </operation>

  </file>
  <file name="admin/model/customer/customer.php">
      <operation info="Insert document type and number into DB after user inserted">
          <search position="after"><![CDATA[
          $customer_id = $this->db->getLastId();
          ]]></search>
          <add><![CDATA[
            if($data['doctype'] == 'cpf'){
            $document_number = preg_replace("/[^0-9]/","",$data['cpf']);
            }elseif($data['doctype'] == 'cnpj'){
            $document_number = preg_replace("/[^0-9]/","",$data['cnpj']);
            }

           $this->db->query("UPDATE " . DB_PREFIX . "customer SET document_type = '" . $this->db->escape($data['doctype']) . "', document_number = '" . $this->db->escape($document_number) . "' WHERE customer_id = '" . (int)$customer_id . "'");

           if($data['doctype'] == 'cnpj'){
           $this->db->query("UPDATE " . DB_PREFIX . "customer SET pj_ie = '" . $this->db->escape($data['cnpj_ie']) . "', razao_social = '" . $this->db->escape($data['razao_social']) . "' WHERE customer_id = '" . (int)$customer_id . "'");
           }
          ]]></add>
      </operation>
      <operation info="Insert addess number into DB after address inserted">
          <search position="after"><![CDATA[
          $address_id = $this->db->getLastId();
          ]]></search>
          <add><![CDATA[
           $this->db->query("UPDATE " . DB_PREFIX . "address SET address_number = '" . $this->db->escape($address['address_number']) . "' WHERE address_id = '" . (int)$address_id . "' AND customer_id = '" . (int)$customer_id . "'");
          ]]></add>
      </operation>
      <operation>
          <search position="after"><![CDATA[
          $this->db->query("UPDATE " . DB_PREFIX . "customer SET customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', custom_field = '" . $this->db->escape(isset($data['custom_field']) ? json_encode($data['custom_field']) : '') . "', newsletter = '" . (int)$data['newsletter'] . "', status = '" . (int)$data['status'] . "', approved = '" . (int)$data['approved'] . "', safe = '" . (int)$data['safe'] . "' WHERE customer_id = '" . (int)$customer_id . "'");
          ]]></search>
          <add><![CDATA[
            if($data['doctype'] == 'cpf'){
            $document_number = preg_replace("/[^0-9]/","",$data['cpf']);
            }elseif($data['doctype'] == 'cnpj'){
            $document_number = preg_replace("/[^0-9]/","",$data['cnpj']);
            }



            $this->db->query("UPDATE " . DB_PREFIX . "customer SET document_type =  '" . $this->db->escape($data['doctype']) . "', document_number =  '" . $this->db->escape($document_number)  . "' WHERE customer_id = '" . (int)$customer_id . "'");

            if($data['doctype'] == 'cnpj'){
            $this->db->query("UPDATE " . DB_PREFIX . "customer SET pj_ie = '" . $this->db->escape($data['cnpj_ie']) . "', razao_social = '" . $this->db->escape($data['razao_social']) . "' WHERE customer_id = '" . (int)$customer_id . "'");
            }
          ]]></add>
      </operation>
      <operation>
          <search position="after"><![CDATA[
          'address_1'      => $address_query->row['address_1'],
          ]]></search>
          <add><![CDATA[
            'address_number'      => $address_query->row['address_number'],
          ]]></add>
      </operation>
  </file>
  <file name="catalog/view/theme/*/template/account/address_form.tpl">
    <operation info="Insert Error into Address 2">
        <search position="after"><![CDATA[
        <input type="text" name="address_2" value="<?php echo $address_2; ?>" placeholder="<?php echo $entry_address_2; ?>" id="input-address-2" class="form-control" />
        ]]></search>
        <add><![CDATA[
          <?php if ($error_address_2) { ?>
          <div class="text-danger"><?php echo $error_address_2; ?></div>
          <?php } ?>
        ]]></add>
    </operation>
      <operation info="Change Postcode Position">
          <search position="replace" offset="6"><![CDATA[
          <label class="col-sm-2 control-label" for="input-postcode"><?php echo $entry_postcode; ?></label>
          ]]></search>
          <add><![CDATA[
          ]]></add>
      </operation>
      <operation info="Change Postcode Position">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-address-1"><?php echo $entry_address_1; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-postcode"><?php echo $entry_postcode; ?></label>
              <div class="col-sm-10">
                <input type="text" name="postcode" value="<?php echo $postcode; ?>" placeholder="<?php echo $entry_postcode; ?>" id="input-postcode" class="form-control" />
                <?php if ($error_postcode) { ?>
                <div class="text-danger"><?php echo $error_postcode; ?></div>
                <?php } ?>
              </div>
            </div>
          ]]></add>
      </operation>
      <operation info="Change Postcode Position">
          <search position="before"><![CDATA[
          <h2><?php echo $text_edit_address; ?></h2>
          ]]></search>
          <add><![CDATA[
            <div class="correios-loading"></div>
          ]]></add>
      </operation>
      <operation info="Add address number">
          <search position="before" offset="1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-city"><?php echo $entry_city; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-address-number">Número</label>
              <div class="col-sm-10">
                <input type="text" name="address_number" placeholder="Número" id="input-address-number" class="form-control" value="<?php echo $address_number; ?>" />
                <?php if ($error_address_number) { ?>
                <div class="text-danger"><?php echo $error_address_number; ?></div>
                <?php } ?>
              </div>
            </div>
          ]]></add>
      </operation>
  </file>
  <file name="catalog/controller/account/address.php">
      <operation info="Assign error variable">
          <search position="before"><![CDATA[
          if (isset($this->error['firstname'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->error['address_number'])) {
        			$data['error_address_number'] = $this->error['address_number'];
        		} else {
        			$data['error_address_number'] = '';
        		}

            if (isset($this->error['address_2'])) {
        			$data['error_address_2'] = $this->error['address_2'];
        		} else {
        			$data['error_address_2'] = '';
        		}
          ]]></add>
      </operation>
      <operation info="Rename address 2">
          <search position="replace"><![CDATA[
          $data['entry_address_2'] = $this->language->get('entry_address_2');
          ]]></search>
          <add><![CDATA[
            $data['entry_address_2'] = 'Bairro';
          ]]></add>
      </operation>


      <operation info="Assign variable">
          <search position="before"><![CDATA[
          if (isset($this->request->post['firstname'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->request->post['address_number'])) {
        			$data['address_number'] = $this->request->post['address_number'];
        		} elseif (!empty($address_info)) {
        			$data['address_number'] = $address_info['address_number'];
        		} else {
        			$data['address_number'] = '';
        		}

            if (isset($this->request->post['address_2'])) {
        			$data['address_2'] = $this->request->post['address_2'];
        		} elseif (!empty($address_info)) {
        			$data['address_2'] = $address_info['address_2'];
        		} else {
        			$data['address_2'] = '';
        		}
          ]]></add>
      </operation>
      <operation info="Assign variable">
          <search position="after"><![CDATA[
          protected function validateForm() {
          ]]></search>
          <add><![CDATA[
            if ((utf8_strlen(trim($this->request->post['address_number'])) < 1) || (utf8_strlen(trim($this->request->post['address_number'])) > 32)) {
        			$this->error['address_number'] = 'Número inválido!';
        		}

            if ((utf8_strlen(trim($this->request->post['address_2'])) < 1) || (utf8_strlen(trim($this->request->post['address_2'])) > 32)) {
        			$this->error['address_2'] = 'Bairro deve conter entre 2 e 32 caracteres!';
        		}
          ]]></add>
      </operation>
  </file>
  <file name="catalog/model/account/address.php">
      <operation info="Insert address number into array">
          <search position="after"><![CDATA[
          'address_id'     => $address_query->row['address_id'],
          ]]></search>
          <add><![CDATA[
            'address_number'     => $address_query->row['address_number'],
          ]]></add>
      </operation>
      <operation info="Update DB address number">
          <search position="after"><![CDATA[
          public function editAddress($address_id, $data) {
          ]]></search>
          <add><![CDATA[
            $this->db->query("UPDATE " . DB_PREFIX . "address SET address_number = '" . (int)$data['address_number'] . "' WHERE address_id  = '" . (int)$address_id . "' AND customer_id = '" . (int)$this->customer->getId() . "'");
          ]]></add>
      </operation>
      <operation info="Add address number to DB">
          <search position="after"><![CDATA[
          $address_id = $this->db->getLastId();
          ]]></search>
          <add><![CDATA[
            $this->db->query("UPDATE " . DB_PREFIX . "address SET address_number = '" . $this->db->escape($data['address_number']) . "' WHERE address_id = '" . (int)$address_id . "' AND customer_id = '" . (int)$this->customer->getId() . "'");
          ]]></add>
      </operation>
  </file>
  <file name="catalog/controller/checkout/guest_shipping.php">
      <operation info="Validate address number">
          <search position="before"><![CDATA[
          if ((utf8_strlen(trim($this->request->post['firstname'])) < 1) || (utf8_strlen(trim($this->request->post['firstname'])) > 32)) {
          ]]></search>
          <add><![CDATA[
            if ((utf8_strlen(trim($this->request->post['address_number'])) < 1) || (utf8_strlen(trim($this->request->post['address_number'])) > 32)) {
              $json['error']['address_number'] = 'Número inválido!';
            }
          ]]></add>
      </operation>
  </file>
  <file name="admin/controller/common/header.php">
      <operation info="Insert header warning message">
          <search position="before"><![CDATA[
          return $this->load->view('common/header', $data);
          ]]></search>
          <add><![CDATA[
            $this->load->controller('module/webmaniabrnfe/displayStatusSefaz');
            $this->load->controller('module/webmaniabrnfe/displayMessageCertificado');
            if(isset($this->session->data['status_sefaz'])){
            $data['status_sefaz'] = $this->session->data['status_sefaz'];
           }
           if(isset($this->session->data['validade_certificado'])){
           $data['validade_certificado'] = $this->session->data['validade_certificado'];
          }
          ]]></add>
      </operation>
  </file>
  <file name="admin/view/template/common/header.tpl">
      <operation info="Insert header warning-message">
          <search position="after"><![CDATA[
          </header>
          ]]></search>
          <add><![CDATA[
            <?php if($logged): ?>
            <?php if(isset($status_sefaz)): ?>
           <div class="alert-wmbr alert-danger header-alert"><?php echo $status_sefaz; ?></div>
           <?php endif; ?>
           <?php if(isset($validade_certificado)): ?>
          <div class="alert-wmbr alert-danger header-alert"><?php echo $validade_certificado; ?></div>
          <?php endif; ?>
          <?php endif; ?>
          ]]></add>
      </operation>
  </file>
  <file name="admin/view/template/catalog/product_form.tpl">
      <operation info="Add custom tab to product config">
          <search position="after"><![CDATA[
          <li><a href="#tab-design" data-toggle="tab"><?php echo $tab_design; ?></a></li>
          ]]></search>
          <add><![CDATA[
          <li><a href="#tab-nfe-config" data-toggle="tab">WebmaniaBR NF-e</a></li>
          ]]></add>
      </operation>
      <operation info="Add custom tab content to product config">
          <search position="before"><![CDATA[
          <div class="tab-pane" id="tab-design">
          ]]></search>
          <add><![CDATA[
            <div class="tab-pane" id="tab-nfe-config">
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-classe-imposto">Classe de Imposto</label>
                <div class="col-sm-10">
                  <input type="text" name="classe_imposto" value="<?php echo $classe_imposto; ?>" placeholder="Classe de Imposto" id="input-classe-imposto" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-ean-barcode">Código de Barras EAN</label>
                <div class="col-sm-10">
                  <input type="text" name="ean_barcode" value="<?php echo $ean_barcode; ?>" placeholder="Código de Barras EAN" id="input-ean-barcode" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-ncm-code">Código NCM</label>
                <div class="col-sm-10">
                  <input type="text" name="ncm_code" value="<?php echo $ncm_code; ?>" placeholder="Código NCM" id="input-ncm-code" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-cest-code">Código CEST</label>
                <div class="col-sm-10">
                  <input type="text" name="cest_code" value="<?php echo $cest_code; ?>" placeholder="Código CEST" id="input-cest-code" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">Origem</label>
                <div class="col-sm-10">
                  <select name="product_source" class="form-control" />
                  <option value="-1">Selecionar</option>
                  <?php
                  $options = array(
                  '0' => '0 - Nacional, exceto as indicadas nos códigos 3, 4, 5 e 8',
                  '1' => '1 - Estrangeira - Importação direta, exceto a indicada no código 6',
                  '2' => '2 - Estrangeira - Adquirida no mercado interno, exceto a indicada no código 7',
                  '3' => '3 - Nacional, mercadoria ou bem com Conteúdo de Importação superior a 40% e inferior ou igual a 70%',
                  '4' => '4 - Nacional, cuja produção tenha sido feita em conformidade com os processos produtivos básicos de que tratam as legislações citadas nos Ajustes',
                  '5' => '5 - Nacional, mercadoria ou bem com Conteúdo de Importação inferior ou igual a 40%',
                  '6' => '6 - Estrangeira - Importação direta, sem similar nacional, constante em lista da CAMEX e gás natural',
                  '7' => '7 - Estrangeira - Adquirida no mercado interno, sem similar nacional, constante lista CAMEX e gás natural',
                  '8' => '8 - Nacional, mercadoria ou bem com Conteúdo de Importação superior a 70%',
                  );

                  foreach($options as $value => $option){
                  $selected = '';
                  if($value == $product_source){
                    $selected = 'selected';
                  }
                    echo '<option value="'.$value.'" '.$selected.'>'.$option.'</option>';
                  }

                  ?>
                </select>
                </div>
              </div>
            </div>

          ]]></add>
      </operation>
  </file>
  <file name="admin/model/catalog/product.php">
      <operation info="Update product with custom info">
          <search position="after"><![CDATA[
          public function editProduct($product_id, $data) {
          ]]></search>
          <add><![CDATA[
            $this->db->query("UPDATE " . DB_PREFIX . "product SET classe_imposto = '" . $this->db->escape($data['classe_imposto']) . "', ean_barcode = '" . $this->db->escape($data['ean_barcode']) . "', ncm_code = '" . $this->db->escape($data['ncm_code']) . "', cest_code = '" . $this->db->escape($data['cest_code']) . "', product_source = '" . $this->db->escape($data['product_source']) . "' WHERE product_id = '" . (int)$product_id . "'");
          ]]></add>
      </operation>
    </file>
    <file name="catalog/view/theme/*/template/checkout/checkout.tpl">
        <operation info="Trigger Event in JS">
            <search position="before"><![CDATA[
            $('a[href=\'#collapse-payment-address\']').trigger('click');
            ]]></search>
            <add><![CDATA[
              $(document).trigger('start-correios');
            ]]></add>
        </operation>
        <operation info="Trigger Event in JS">
            <search position="before"><![CDATA[
            $('a[href=\'#collapse-shipping-address\']').trigger('click');
            ]]></search>
            <add><![CDATA[
              $(document).trigger('start-correios');
            ]]></add>
        </operation>
      </file>
    <file name="admin/controller/catalog/product.php">
      <operation info="Assign custom fields variables">
          <search position="before"><![CDATA[
          if (isset($this->request->post['model'])) {
          ]]></search>
          <add><![CDATA[
            if (isset($this->request->post['classe_imposto'])) {
        			$data['classe_imposto'] = $this->request->post['classe_imposto'];
        		} elseif (!empty($product_info)) {
        			$data['classe_imposto'] = $product_info['classe_imposto'];
        		} else {
        			$data['classe_imposto'] = '';
        		}

            if (isset($this->request->post['ean_barcode'])) {
        			$data['ean_barcode'] = $this->request->post['ean_barcode'];
        		} elseif (!empty($product_info)) {
        			$data['ean_barcode'] = $product_info['ean_barcode'];
        		} else {
        			$data['ean_barcode'] = '';
        		}

            if (isset($this->request->post['ncm_code'])) {
        			$data['ncm_code'] = $this->request->post['ncm_code'];
        		} elseif (!empty($product_info)) {
        			$data['ncm_code'] = $product_info['ncm_code'];
        		} else {
        			$data['ncm_code'] = '';
        		}

            if (isset($this->request->post['cest_code'])) {
        			$data['classe_imposto'] = $this->request->post['cest_code'];
        		} elseif (!empty($product_info)) {
        			$data['cest_code'] = $product_info['cest_code'];
        		} else {
        			$data['cest_code'] = '';
        		}

            if (isset($this->request->post['product_source'])) {
        			$data['product_source'] = $this->request->post['product_source'];
        		} elseif (!empty($product_info)) {
        			$data['product_source'] = $product_info['product_source'];
        		} else {
        			$data['product_source'] = '';
        		}
          ]]></add>
      </operation>
  </file>
  <file name="admin/view/template/customer/customer_form.tpl">
    <operation info="Insert new document type fields">
        <search position="before" offset="1"><![CDATA[
        <label class="col-sm-2 control-label" for="input-firstname"><?php echo $entry_firstname; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="col-sm-2 control-label">Tipo de Pessoa</label>
            <div class="col-sm-10">
              <?php if($doctype == 'cnpj'): ?>
              <input type="radio" name="doctype" value="cpf" /> <span class="radio-label">Pessoa Física</span>
              <input type="radio" name="doctype" value="cnpj" checked/> <span class="radio-label">Pessoa Jurídica</span>
              <?php else: ?>
              <input type="radio" name="doctype" value="cpf" checked/> <span class="radio-label">Pessoa Física</span>
              <input type="radio" name="doctype" value="cnpj" /> <span class="radio-label">Pessoa Jurídica</span>
              <?php endif; ?>

            </div>
          </div>
          <div class="form-group required" id="cpf-group" <?php if($doctype == 'cnpj') echo 'style="display:none;"'; ?>>
            <label class="col-sm-2 control-label">CPF</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="cpf" id="cpf" placeholder="CPF" value="<?php if($doctype == 'cpf') echo $document_number; ?>"/>
              <?php if ($error_cpf) { ?>
              <div class="text-danger"><?php echo $error_cpf; ?></div>
              <?php } ?>
            </div>
          </div>
          <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
            <label class="col-sm-2 control-label">Razão Social</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="razao_social" placeholder="Razão Social" value="<?php echo $razao_social; ?>"/>
              <?php if ($error_razao_social) { ?>
              <div class="text-danger"><?php echo $error_razao_social; ?></div>
              <?php } ?>
            </div>
          </div>
          <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
            <label class="col-sm-2 control-label">CNPJ</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="cnpj" id="cnpj" placeholder="CNPJ" value="<?php if($doctype == 'cnpj') echo $document_number; ?>"/>
              <?php if ($error_cnpj) { ?>
              <div class="text-danger"><?php echo $error_cnpj; ?></div>
              <?php } ?>
            </div>
          </div>
          <div class="form-group required cnpj-group" <?php if($doctype == 'cnpj') echo 'style="display:block;"'; ?>>
            <label class="col-sm-2 control-label">Inscrição Estadual</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="cnpj_ie" placeholder="Inscrição Estadual" value="<?php echo $cnpj_ie; ?>"/>
              <?php if ($error_cnpj_ie) { ?>
              <div class="text-danger"><?php echo $error_cnpj_ie; ?></div>
              <?php } ?>
            </div>
          </div>
        ]]></add>
    </operation>
    <operation info="Add address error">
        <search position="after"><![CDATA[
        <input type="text" name="address[<?php echo $address_row; ?>][address_2]" value="<?php echo $address['address_2']; ?>" placeholder="<?php echo $entry_address_2; ?>" id="input-address-2<?php echo $address_row; ?>" class="form-control" />
        ]]></search>
        <add><![CDATA[
          <?php if (isset($error_address[$address_row]['address_2'])) { ?>
          <div class="text-danger"><?php echo $error_address[$address_row]['address_2']; ?></div>
          <?php } ?>
        ]]></add>
    </operation>
    <operation info="Add address number">
        <search position="before" offset="1"><![CDATA[
        <label class="col-sm-2 control-label" for="input-address-2<?php echo $address_row; ?>"><?php echo $entry_address_2; ?></label>
        ]]></search>
        <add><![CDATA[
          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-address-number<?php echo $address_row; ?>">Número</label>
            <div class="col-sm-10">
              <input type="text" name="address[<?php echo $address_row; ?>][address_number]" value="<?php echo $address['address_number']; ?>" placeholder="Número" id="input-address-number<?php echo $address_row; ?>" class="form-control" />
              <?php if (isset($error_address[$address_row]['address_number'])) { ?>
              <div class="text-danger"><?php echo $error_address[$address_row]['address_number']; ?></div>
              <?php } ?>
            </div>
          </div>
        ]]></add>
    </operation>
    <operation info="Add address number">
        <search position="before" offset="1"><![CDATA[
        html += '    <label class="col-sm-2 control-label" for="input-address-2' + address_row + '"><?php echo $entry_address_2; ?></label>';
        ]]></search>
        <add><![CDATA[
          html += '  <div class="form-group">';
        	html += '    <label class="col-sm-2 control-label" for="input-address-number' + address_row + '">Número</label>';
        	html += '    <div class="col-sm-10"><input type="text" name="address[' + address_row + '][address_number]" value="" placeholder="Número" id="input-address-number' + address_row + '" class="form-control" /></div>';
        	html += '  </div>';
        ]]></add>
    </operation>
    <operation info="Trigger Event">
        <search position="after"><![CDATA[
        $('#tab-general .tab-content').append(html);
        ]]></search>
        <add><![CDATA[
          $(document).trigger('add-address', [address_row]);
        ]]></add>
    </operation>
    </file>

    <file name="admin/controller/customer/customer.php">
        <operation info="Custom fields admin">
            <search position="before"><![CDATA[
            if ((utf8_strlen($this->request->post['firstname']) < 1) || (utf8_strlen(trim($this->request->post['firstname'])) > 32)) {
            ]]></search>
            <add><![CDATA[
              if ( $this->request->post['doctype'] == 'cpf' && ((utf8_strlen(trim($this->request->post['cpf'])) < 1) || (utf8_strlen(trim($this->request->post['cpf'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCPF', array($this->request->post['cpf'])) === false)) {
                $this->error['cpf'] = 'CPF Inválido!';
              }



              if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj'])) > 32) || $this->load->controller('module/webmaniabrnfe/validaCNPJ', array($this->request->post['cnpj'])) === false)) {
                $this->error['cnpj'] = 'CNPJ Inválido!';
              }

              if ( $this->request->post['doctype'] == 'cnpj' && ((utf8_strlen(trim($this->request->post['cnpj_ie'])) < 1) || (utf8_strlen(trim($this->request->post['cnpj_ie'])) > 32))) {
                $this->error['cnpj_ie'] = 'Inscrição estadual inválida!';
              }

              if ($this->request->post['doctype'] == 'cnpj'){
                if ((utf8_strlen(trim($this->request->post['razao_social'])) < 1) || (utf8_strlen(trim($this->request->post['razao_social'])) > 50)) {
                  $this->error['razao_social'] = 'Razão social obrigatória!';
                }
              }

            ]]></add>
        </operation>
        <operation info="Define error variable">
            <search position="before"><![CDATA[
            if (isset($this->error['firstname'])) {
            ]]></search>
            <add><![CDATA[
              if (isset($this->error['cpf'])) {
                $data['error_cpf'] = $this->error['cpf'];
              } else {
                $data['error_cpf'] = '';
              }
              if (isset($this->error['cnpj'])) {
                $data['error_cnpj'] = $this->error['cnpj'];
              } else {
                $data['error_cnpj'] = '';
              }


              if (isset($this->error['cnpj_ie'])) {
                $data['error_cnpj_ie'] = $this->error['cnpj_ie'];
              } else {
                $data['error_cnpj_ie'] = '';
              }

              if (isset($this->error['razao_social'])) {
                $data['error_razao_social'] = $this->error['razao_social'];
              } else {
                $data['error_razao_social'] = '';
              }
            ]]></add>
        </operation>
        <operation info="Define requested POST vars">
            <search position="before"><![CDATA[
            if (isset($this->request->post['firstname'])) {
            ]]></search>
            <add><![CDATA[

              if (isset($this->request->post['doctype'])) {
               $data['doctype'] = $this->request->post['doctype'];
             } elseif (!empty($customer_info)) {
               $data['doctype'] = $customer_info['document_type'];
             }else {
               $data['doctype'] = '';
             }

              if (isset($this->request->post['doctype'])) {
                if($this->request->post['doctype'] == 'cpf'){
                  $data['document_number'] = $this->request->post['cpf'];
                }elseif($this->request->post['doctype'] == 'cnpj'){
                  $data['document_number'] = $this->request->post['cnpj'];
                }
             } elseif (!empty($customer_info)) {
               $data['document_number'] = $customer_info['document_number'];
             }else {
               $data['document_number'] = '';
             }

            if (isset($this->request->post['cnpj_ie'])) {
             $data['cnpj_ie'] = $this->request->post['cnpj_ie'];
           } elseif (!empty($customer_info)) {
             $data['cnpj_ie'] = $customer_info['pj_ie'];
           }else {
             $data['cnpj_ie'] = '';
           }


           if (isset($this->request->post['razao_social'])) {
            $data['razao_social'] = $this->request->post['razao_social'];
          } elseif (!empty($customer_info)) {
            $data['razao_social'] = $customer_info['razao_social'];
          }else {
            $data['razao_social'] = '';
          }
            ]]></add>
        </operation>
        <operation info="Rename Address 2">
            <search position="replace"><![CDATA[
            $data['entry_address_2'] = $this->language->get('entry_address_2');
            ]]></search>
            <add><![CDATA[
            $data['entry_address_2'] = 'Bairro';
            ]]></add>
        </operation>
        <operation info="Address 2 Required">
            <search position="before"><![CDATA[
            if (isset($this->error['address'])) {
            ]]></search>
            <add><![CDATA[
              if (isset($this->error['address_2'])) {
          			$data['error_address_2'] = $this->error['address_2'];
          		} else {
          			$data['error_address_2'] = array();
          		}
            ]]></add>
        </operation>
        <operation info="Address 2 and number Error">
            <search position="after"><![CDATA[
          foreach ($this->request->post['address'] as $key => $value) {
            ]]></search>
            <add><![CDATA[
              if ((utf8_strlen($value['address_2']) < 3) || (utf8_strlen($value['address_2']) > 32)) {
      					$this->error['address'][$key]['address_2'] = 'Bairro deve conter entre 3 e 32 caracteres';
      				}

              if ((utf8_strlen($value['address_number']) < 3) || (utf8_strlen($value['address_number']) > 32)) {
      					$this->error['address'][$key]['address_number'] = 'Número obrigatório';
      				}
            ]]></add>
        </operation>
      </file>
</modification>
